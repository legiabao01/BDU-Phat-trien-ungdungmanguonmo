{% extends "base.html" %}

{% block title %}{{ course.tieu_de }} - Học Trực Tuyến{% endblock %}

{% block content %}
<div class="container my-5">
    <div class="row">
        <div class="col-md-8">
            <h1 class="mb-3">{{ course.tieu_de }}</h1>
            <div class="mb-4">
                <span class="badge-custom badge-info me-2">{{ course.cap_do or 'N/A' }}</span>
                <span class="badge-custom badge-success">{{ course.hinh_thuc or 'online' }}</span>
            </div>
            
            {% if course.hinh_anh %}
            <img src="{{ course.hinh_anh }}" class="img-fluid rounded mb-4 shadow" alt="{{ course.tieu_de }}" style="max-height: 400px; width: 100%; object-fit: cover;">
            {% endif %}
            
            <div class="mb-4">
                <h3 class="title-gradient">Mô tả khóa học</h3>
                <p class="text-muted fs-5">{{ course.mo_ta or 'Chưa có mô tả' }}</p>
            </div>

            {% if details %}
            <div class="mb-4">
                <h3 class="title-gradient">Nội dung khóa học</h3>
                <div class="list-group">
                    {% for detail in details %}
                    <div class="list-group-item border-0 shadow-sm mb-2 rounded">
                        <h5 class="mb-2"><i class="bi bi-check-circle text-brand-green me-2"></i>{{ detail.tieu_de_muc }}</h5>
                        {% if detail.noi_dung %}
                        <p class="mb-0 text-muted">{{ detail.noi_dung }}</p>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}

            <!-- Reviews Section -->
            <div class="mb-4">
                <h3 class="title-gradient">Đánh giá ({{ reviews|length }})</h3>
                
                <!-- Form đánh giá -->
                {% if session.user_id %}
                    {% set can_review = True %}
                    {% for review in reviews %}
                        {% if review.user_id == session.user_id %}
                            {% set can_review = False %}
                        {% endif %}
                    {% endfor %}
                    
                    {% if can_review %}
                    <div class="card-soft mb-3">
                        <h5>Viết đánh giá</h5>
                        <form method="POST" action="{{ url_for('add_review', course_id=course.id) }}">
                            <div class="mb-3">
                                <label class="form-label">Điểm số (1-5 sao)</label>
                                <select class="form-select" name="diem_so" required>
                                    <option value="5">5 sao - Tuyệt vời</option>
                                    <option value="4">4 sao - Rất tốt</option>
                                    <option value="3">3 sao - Tốt</option>
                                    <option value="2">2 sao - Bình thường</option>
                                    <option value="1">1 sao - Không hài lòng</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Nhận xét</label>
                                <textarea class="form-control" name="noi_dung" rows="3" placeholder="Chia sẻ trải nghiệm của bạn..."></textarea>
                            </div>
                            <button type="submit" class="btn btn-primary-custom">Gửi đánh giá</button>
                        </form>
                    </div>
                    {% endif %}
                {% endif %}
                
                <!-- Danh sách đánh giá -->
                {% if reviews %}
                    {% for review in reviews %}
                    <div class="card-soft mb-2">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <strong class="text-brand-sky">{{ review.ho_ten }}</strong>
                            <div>
                                {% for i in range(1, 6) %}
                                    {% if i <= review.diem_so %}
                                        <i class="bi bi-star-fill text-warning"></i>
                                    {% else %}
                                        <i class="bi bi-star text-secondary"></i>
                                    {% endif %}
                                {% endfor %}
                            </div>
                        </div>
                        {% if review.noi_dung %}
                        <p class="mb-2">{{ review.noi_dung }}</p>
                        {% endif %}
                        <small class="text-muted"><i class="bi bi-calendar"></i> {{ review.created_at.strftime('%d/%m/%Y') }}</small>
                    </div>
                    {% endfor %}
                {% else %}
                    <p class="text-muted">Chưa có đánh giá nào.</p>
                {% endif %}
            </div>

            <!-- Discussion Section -->
            <div class="mb-4">
                <h3 class="title-gradient">Thảo luận</h3>
                {% if session.user_id %}
                <div class="card-soft mb-3">
                    <form method="POST" action="{{ url_for('add_discussion', course_id=course.id) }}">
                        <label class="form-label">Chia sẻ câu hỏi hoặc thảo luận</label>
                        <textarea name="noi_dung" class="form-control mb-3" rows="3" placeholder="Nhập nội dung..."></textarea>
                        <button type="submit" class="btn btn-primary-custom btn-sm">Gửi</button>
                    </form>
                </div>
                {% else %}
                <div class="alert alert-info">Đăng nhập để tham gia thảo luận.</div>
                {% endif %}

                {% if discussions %}
                    {% for d in discussions %}
                    <div class="card-soft mb-2">
                        <div class="d-flex justify-content-between align-items-start mb-1">
                            <div>
                                <strong class="text-brand-sky">{{ d.ho_ten }}</strong>
                                <small class="text-muted ms-2">{{ d.created_at.strftime('%d/%m/%Y %H:%M') }}</small>
                            </div>
                        </div>
                        <p class="mb-0">{{ d.noi_dung }}</p>
                    </div>
                    {% endfor %}
                {% else %}
                    <p class="text-muted">Chưa có thảo luận nào.</p>
                {% endif %}
            </div>
        </div>

        <div class="col-md-4">
            <div class="card-soft sticky-top" style="top: 100px;">
                <h4 class="mb-4">Thông tin khóa học</h4>
                <ul class="list-unstyled mb-4">
                    <li class="mb-3"><i class="bi bi-calendar text-brand-sky me-2"></i> Số buổi: <strong>{{ course.so_buoi or 'N/A' }}</strong></li>
                    <li class="mb-3"><i class="bi bi-clock text-brand-sky me-2"></i> Thời lượng: <strong>{{ course.thoi_luong or 'N/A' }}</strong></li>
                    <li class="mb-3"><i class="bi bi-star text-brand-sky me-2"></i> Đánh giá: <strong>{{ "%.1f"|format(course.danh_gia_trung_binh) }}/5.0</strong> ({{ course.so_luong_danh_gia }} đánh giá)</li>
                </ul>
                <hr>
                <div class="text-center mb-4">
                    <h3 class="text-brand-sky mb-2">{{ "{:,.0f}".format(course.gia) }} VNĐ</h3>
                    {% if course.gia_goc and course.gia < course.gia_goc %}
                    <p class="text-muted mb-0"><del>{{ "{:,.0f}".format(course.gia_goc) }} VNĐ</del></p>
                    {% endif %}
                </div>
                <hr>
                {% if session.user_id %}
                    <button class="btn btn-primary-custom w-100 mb-2" onclick="buyCourse({{ course.id }})">
                        <i class="bi bi-cart-plus"></i> Mua/Đăng ký ngay
                    </button>
                {% else %}
                    <a href="{{ url_for('login') }}" class="btn btn-primary-custom w-100 mb-2">
                        <i class="bi bi-box-arrow-in-right"></i> Đăng nhập để đăng ký
                    </a>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<script>
function buyCourse(courseId) {
    fetch(`/course/${courseId}/buy`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Đăng ký thành công!');
            window.location.href = '/dashboard';
        } else {
            alert(data.message || 'Có lỗi xảy ra');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Có lỗi xảy ra khi đăng ký');
    });
}
</script>
{% endblock %}
