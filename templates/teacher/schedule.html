{% extends "base.html" %}

{% block title %}Quản lý lịch học - {{ course.tieu_de }}{% endblock %}

{% block content %}
<div class="container my-5">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="title-gradient mb-0">
            <i class="bi bi-calendar-event"></i> Quản lý lịch học
        </h1>
        <a href="{{ url_for('dashboard') }}" class="btn btn-outline-custom">
            <i class="bi bi-arrow-left"></i> Về Dashboard
        </a>
    </div>

    <div class="card-soft mb-4">
        <h5 class="mb-3">
            <i class="bi bi-book"></i> {{ course.tieu_de }}
        </h5>
        <p class="text-muted mb-4">{{ course.mo_ta or 'Không có mô tả' }}</p>
    </div>

    <!-- Form thêm lịch học -->
    <div class="card-soft mb-4">
        <h4 class="title-gradient mb-3">
            <i class="bi bi-plus-circle"></i> Thêm buổi học mới
        </h4>
        <form method="POST" action="{{ url_for('teacher_create_schedule', course_id=course.id) }}" enctype="multipart/form-data">
            <div class="row">
                <div class="col-md-3 mb-3">
                    <label class="form-label">Ngày học <span class="text-danger">*</span></label>
                    <input type="date" class="form-control" name="ngay_hoc" required>
                </div>
                <div class="col-md-2 mb-3">
                    <label class="form-label">Giờ bắt đầu <span class="text-danger">*</span></label>
                    <input type="time" class="form-control" name="gio_bat_dau" required>
                </div>
                <div class="col-md-2 mb-3">
                    <label class="form-label">Giờ kết thúc <span class="text-danger">*</span></label>
                    <input type="time" class="form-control" name="gio_ket_thuc" required>
                </div>
                <div class="col-md-2 mb-3">
                    <label class="form-label">Hình thức</label>
                    <select class="form-select" name="hinh_thuc" id="hinh_thuc" onchange="toggleLocationField()">
                        <option value="online">Online</option>
                        <option value="offline">Offline</option>
                        <option value="hybrid">Hybrid</option>
                    </select>
                </div>
                <div class="col-md-3 mb-3" id="location_field">
                    <label class="form-label">Link Zoom / Phòng học</label>
                    <input type="text" class="form-control" name="link_zoom" id="link_zoom" 
                           placeholder="https://zoom.us/j/... hoặc Tên phòng">
                </div>
            </div>
            
            <div class="row">
                <div class="col-md-12 mb-3">
                    <label class="form-label">Ghi chú</label>
                    <textarea class="form-control" name="ghi_chu" rows="2" 
                              placeholder="Ghi chú về buổi học (tùy chọn)"></textarea>
                </div>
            </div>

            <div class="row">
                <div class="col-md-12 mb-3">
                    <label class="form-label">
                        <i class="bi bi-file-earmark-pdf"></i> Bài giảng (PDF, PPT, DOCX, hoặc link)
                    </label>
                    <div class="input-group">
                        <input type="file" class="form-control" name="bai_giang_file" 
                               accept=".pdf,.ppt,.pptx,.doc,.docx,.txt" id="bai_giang_file">
                        <span class="input-group-text">hoặc</span>
                        <input type="url" class="form-control" name="bai_giang_link" 
                               placeholder="Link Google Drive, OneDrive, hoặc URL khác">
                    </div>
                    <small class="text-muted">
                        <i class="bi bi-info-circle"></i> Có thể upload file hoặc nhập link. Nếu upload file, link sẽ bị bỏ qua.
                    </small>
                </div>
            </div>

            <button type="submit" class="btn btn-primary-custom">
                <i class="bi bi-check-circle"></i> Thêm buổi học
            </button>
        </form>
    </div>

    <!-- Danh sách lịch học -->
    <div class="card-soft">
        <h4 class="title-gradient mb-3">
            <i class="bi bi-list-ul"></i> Danh sách lịch học ({{ schedules|length }} buổi)
        </h4>
        
        {% if schedules %}
        <div class="table-responsive">
            <table class="table table-hover align-middle">
                <thead class="table-light">
                    <tr>
                        <th style="width: 5%;">#</th>
                        <th style="width: 15%;">Ngày học</th>
                        <th style="width: 12%;">Giờ học</th>
                        <th style="width: 20%;">Link/Phòng</th>
                        <th style="width: 20%;">Bài giảng</th>
                        <th style="width: 15%;">Ghi chú</th>
                        <th style="width: 13%;">Thao tác</th>
                    </tr>
                </thead>
                <tbody>
                    {% for s in schedules %}
                    <tr>
                        <td><strong>{{ loop.index }}</strong></td>
                        <td>
                            <strong>{{ s.ngay_hoc.strftime('%d/%m/%Y') if s.ngay_hoc else 'N/A' }}</strong>
                            <br>
                            <small class="text-muted">
                                {% if s.ngay_hoc %}
                                    {% set weekday = s.ngay_hoc.strftime('%A') %}
                                    {% if weekday == 'Monday' %}Thứ 2
                                    {% elif weekday == 'Tuesday' %}Thứ 3
                                    {% elif weekday == 'Wednesday' %}Thứ 4
                                    {% elif weekday == 'Thursday' %}Thứ 5
                                    {% elif weekday == 'Friday' %}Thứ 6
                                    {% elif weekday == 'Saturday' %}Thứ 7
                                    {% elif weekday == 'Sunday' %}Chủ nhật
                                    {% else %}{{ weekday }}
                                    {% endif %}
                                {% endif %}
                            </small>
                        </td>
                        <td>
                            <i class="bi bi-clock text-primary"></i>
                            <strong>{{ s.gio_bat_dau }} - {{ s.gio_ket_thuc }}</strong>
                        </td>
                        <td>
                            {% if s.link_zoom %}
                                {% if 'zoom' in s.link_zoom.lower() or 'http' in s.link_zoom.lower() %}
                                <a href="{{ s.link_zoom }}" target="_blank" class="btn btn-sm btn-primary">
                                    <i class="bi bi-camera-video"></i> Zoom
                                </a>
                                {% else %}
                                <span class="badge bg-secondary">
                                    <i class="bi bi-building"></i> {{ s.link_zoom }}
                                </span>
                                {% endif %}
                            {% else %}
                            <span class="text-muted small">Chưa có</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if s.bai_giang %}
                                {% if s.bai_giang.startswith('http') or s.bai_giang.startswith('/') %}
                                <a href="{{ s.bai_giang }}" target="_blank" class="btn btn-sm btn-success">
                                    <i class="bi bi-download"></i> Tải bài giảng
                                </a>
                                {% else %}
                                <a href="/{{ s.bai_giang }}" target="_blank" class="btn btn-sm btn-success">
                                    <i class="bi bi-file-earmark-pdf"></i> Xem bài giảng
                                </a>
                                {% endif %}
                            {% else %}
                            <span class="text-muted small">Chưa có</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if s.ghi_chu %}
                            <small class="text-muted">{{ s.ghi_chu[:50] }}{% if s.ghi_chu|length > 50 %}...{% endif %}</small>
                            {% else %}
                            <span class="text-muted small">-</span>
                            {% endif %}
                        </td>
                        <td>
                            <a href="{{ url_for('teacher_edit_schedule', course_id=course.id, schedule_id=s.id) }}" 
                               class="btn btn-sm btn-outline-primary">
                                <i class="bi bi-pencil"></i> Sửa
                            </a>
                            <form method="POST" action="{{ url_for('teacher_delete_schedule', course_id=course.id, schedule_id=s.id) }}" 
                                  style="display: inline;" onsubmit="return confirm('Bạn có chắc muốn xóa buổi học này?');">
                                <button type="submit" class="btn btn-sm btn-outline-danger">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </form>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="alert alert-info">
            <i class="bi bi-info-circle"></i> Chưa có lịch học nào. Hãy thêm buổi học đầu tiên!
        </div>
        {% endif %}
    </div>
</div>

<script>
function toggleLocationField() {
    const hinhThuc = document.getElementById('hinh_thuc').value;
    const linkZoom = document.getElementById('link_zoom');
    const locationField = document.getElementById('location_field');
    
    if (hinhThuc === 'online') {
        linkZoom.placeholder = 'https://zoom.us/j/... hoặc Link online khác';
    } else if (hinhThuc === 'offline') {
        linkZoom.placeholder = 'Tên phòng học (VD: Phòng 101, Tầng 2)';
    } else {
        linkZoom.placeholder = 'Link Zoom hoặc Tên phòng';
    }
}
</script>
{% endblock %}

