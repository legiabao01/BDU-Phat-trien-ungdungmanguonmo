{% extends "base.html" %}

{% block title %}Thanh toán - {{ course.tieu_de }}{% endblock %}

{% block content %}
<div class="container my-5">
    <div class="row">
        <div class="col-lg-8">
            <div class="card-soft mb-4">
                <h2 class="title-gradient mb-4">
                    <i class="bi bi-credit-card"></i> Thông tin thanh toán
                </h2>
                
                <form method="POST" action="{{ url_for('process_payment', course_id=course.id) }}" id="checkoutForm">
                    <div class="mb-4">
                        <h5 class="mb-3">Phương thức thanh toán</h5>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <div class="card border-2 payment-method" onclick="selectPaymentMethod('bank')" style="cursor: pointer;">
                                    <div class="card-body text-center">
                                        <i class="bi bi-bank" style="font-size: 2rem; color: #0d6efd;"></i>
                                        <h6 class="mt-2">Chuyển khoản ngân hàng</h6>
                                        <small class="text-muted">Thanh toán qua tài khoản ngân hàng</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <div class="card border-2 payment-method" onclick="selectPaymentMethod('momo')" style="cursor: pointer;">
                                    <div class="card-body text-center">
                                        <i class="bi bi-phone" style="font-size: 2rem; color: #c2185b;"></i>
                                        <h6 class="mt-2">Ví MoMo</h6>
                                        <small class="text-muted">Thanh toán qua ứng dụng MoMo</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <div class="card border-2 payment-method active" onclick="selectPaymentMethod('sandbox')" style="cursor: pointer;">
                                    <div class="card-body text-center">
                                        <i class="bi bi-wallet2" style="font-size: 2rem; color: #28a745;"></i>
                                        <h6 class="mt-2">Thanh toán thử nghiệm</h6>
                                        <small class="text-muted">Môi trường test (tự động thành công)</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <input type="hidden" name="payment_method" id="payment_method" value="sandbox" required>
                    </div>

                    <div class="mb-4">
                        <h5 class="mb-3">Thông tin người nhận</h5>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Họ và tên <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" name="ho_ten" value="{{ session.ho_ten }}" required readonly>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Email <span class="text-danger">*</span></label>
                                <input type="email" class="form-control" name="email" value="{{ session.email }}" required readonly>
                            </div>
                            <div class="col-md-12 mb-3">
                                <label class="form-label">Số điện thoại</label>
                                <input type="tel" class="form-control" name="so_dien_thoai" placeholder="Nhập số điện thoại (tùy chọn)">
                            </div>
                        </div>
                    </div>

                    <div class="mb-4">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="agree_terms" required>
                            <label class="form-check-label" for="agree_terms">
                                Tôi đồng ý với <a href="#" target="_blank">Điều khoản và Điều kiện</a> của khóa học
                            </label>
                        </div>
                    </div>

                    <div class="d-flex justify-content-between">
                        <a href="{{ url_for('course_detail', course_id=course.id) }}" class="btn btn-outline-secondary">
                            <i class="bi bi-arrow-left"></i> Quay lại
                        </a>
                        <button type="submit" class="btn btn-primary-custom btn-lg" id="submitBtn">
                            <i class="bi bi-lock-fill"></i> Xác nhận thanh toán
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <div class="col-lg-4">
            <div class="card-soft sticky-top" style="top: 20px;">
                <h5 class="mb-3">Đơn hàng của bạn</h5>
                
                <div class="d-flex align-items-center mb-3">
                    {% if course.hinh_anh %}
                    <img src="{{ course.hinh_anh }}" class="rounded me-3" style="width: 80px; height: 80px; object-fit: cover;">
                    {% else %}
                    <div class="bg-secondary rounded me-3 d-flex align-items-center justify-content-center" style="width: 80px; height: 80px;">
                        <i class="bi bi-book text-white" style="font-size: 2rem;"></i>
                    </div>
                    {% endif %}
                    <div class="flex-grow-1">
                        <h6 class="mb-1">{{ course.tieu_de }}</h6>
                        <small class="text-muted">
                            <i class="bi bi-calendar"></i> {{ course.so_buoi }} buổi học
                            {% if course.hinh_thuc %}
                            <br><i class="bi bi-laptop"></i> {{ course.hinh_thuc }}
                            {% endif %}
                        </small>
                    </div>
                </div>

                <hr>

                <div class="d-flex justify-content-between mb-2">
                    <span>Giá khóa học:</span>
                    <strong>{{ "{:,.0f}".format(course.gia) }} VNĐ</strong>
                </div>
                <div class="d-flex justify-content-between mb-2">
                    <span>Giảm giá:</span>
                    <span class="text-success">0 VNĐ</span>
                </div>
                <hr>
                <div class="d-flex justify-content-between mb-3">
                    <h5>Tổng cộng:</h5>
                    <h4 class="text-brand-green mb-0">{{ "{:,.0f}".format(course.gia) }} VNĐ</h4>
                </div>

                <div class="alert alert-info small mb-0">
                    <i class="bi bi-info-circle"></i> Sau khi thanh toán thành công, bạn sẽ được tự động ghi danh vào khóa học.
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function selectPaymentMethod(method) {
    // Remove active class from all
    document.querySelectorAll('.payment-method').forEach(el => {
        el.classList.remove('active', 'border-primary');
        el.classList.add('border-2');
    });
    
    // Add active class to selected
    event.currentTarget.classList.add('active', 'border-primary');
    event.currentTarget.classList.remove('border-2');
    
    document.getElementById('payment_method').value = method;
}

document.getElementById('checkoutForm').addEventListener('submit', function(e) {
    const submitBtn = document.getElementById('submitBtn');
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Đang xử lý...';
});
</script>

<style>
.payment-method {
    transition: all 0.3s;
}
.payment-method:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}
.payment-method.active {
    border-color: #0d6efd !important;
    background-color: #f0f8ff;
}
</style>
{% endblock %}

